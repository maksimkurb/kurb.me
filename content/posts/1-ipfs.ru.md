---
title: Введение в IPFS
date: '2021-11-17'
author: Maxim Kurbatov
cover: post-resources/1-ipfs/ipfs-logo.jpg
readingTime: true
description: В данном материале я расскажу, что такое IPFS и с чем его едят
---

Выясним что же такое IPFS.

> **IPFS (InterPlanetary File System)** --- это распределённая система для хранения и доступа к файлам, вебсайтам, приложениям и данным.

IPFS --- это пиринговая сеть хранения данных. Контент доступен через одноранговые узлы, расположенные в любой точке мира, которые могут передавать информацию, хранить ее или делать и то, и другое. Принцип работы IPFS схож с работой BitTorrent-клиентов, IPFS тоже использует _распределённые хеш-таблицы_ (**DHT**) и способен за секунды найти участников сети, которые могут поделиться запрашиваемыми файлами. Чтобы понять, какие это даёт преимущества, стоит понять разницу в том, как мы сёрфим привычный нам интернет и как это отличается от подхода, предлагаемого IPFS.

Когда мы пользуемся браузером, для доступа к контенту мы используем **URL** (**Uniform Resource Locator**), который говорит, где мы можем найти тот или иной контент.
Пример такого адреса --- `https://mysite.com/my_perfect_book.pdf`

Что мы можем понять из этого адреса? Файл называется `my_perfect_book.pdf`, находится на сайте `mysite.com`, IP-адрес которого мы можем узнать с помощью **DNS**. Нам неизвестно ничего о содержимом контента, пока мы не загрузим его, более того, содержимое может меняться со временем, так [мы можем скачать совсем не то, что ожидали](https://int0x33.medium.com/solarwinds-what-probably-most-likely-happened-ec4e588ce5da). Также есть риск того, что материалы будут подвергнуты цензуре (возможно, [даже по ошибке](https://www.linux.org.ru/forum/talks/14315937)), либо сайт просто прекратит своё существование.

В IPFS, в отличие от классического веба, используются адреса следующего вида: `QmXoypizjW3WknFiJnKLwHCnL72vedxjQkDDP1mXWo6uco`, называемые **Content Identifier** (сокращённо **CID**). В отличие от традиционных **URL**, которые указывают на то, где файл расположен, адреса **IPFS** создаются на основе содержимого контента (если быть точнее, вычисляется [криптографический хеш](https://ru.wikipedia.org/wiki/%D0%9A%D1%80%D0%B8%D0%BF%D1%82%D0%BE%D0%B3%D1%80%D0%B0%D1%84%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B0%D1%8F_%D1%85%D0%B5%D1%88-%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D1%8F)). Это даёт нам два преимущества:

1.  Мы всегда можем проверить, что скачанные нами данные не были подменены кем-либо, просто посчитав для него хеш-функцию. Если хоть один байт файла отличается, хеши просто не совпадут, и IPFS отбросит такой файл.

2.  Так как адрес указывает не "откуда", а "какие" получить данные, их становится гораздо сложнее подвергнуть цензуре. Файлы могут находиться сразу в нескольких хранилищах, в кеше пользователей IPFS, поэтому даже если полностью заблокировать весь внешний интернет, данные можно будет получить, если они остались в хранилище хотя бы у одного достижимого пира.

## Как устроен IPFS?

Для понимания IPFS необходимо разобрать 3 фундаментальных принципа:

1.  Уникальная идентификация ресурса с помощью контентной адресации

2.  Связывание контента с помощью направленных ациклических графиков (DAGs)

3.  Обнаружение контента с помощью распределенных хэш-таблиц (DHTs)

### Контентная адресация в IPFS

Данный пункт мы уже частично разобрали выше, для каждого образа данных создаётся **Content Identifier** (**CID**) --- хеш-сумма, которая уникально адресует эти данные. На самом деле, помимо хеш-суммы, CID содержит версию (сейчас их существует две, CID версии 0 начинаются на `Qm`, CID версии 1 устроены несколько сложнее и содержат в себе [префикс способа кодирования](https://github.com/multiformats/multibase#multibase-table) CID и [формат содержимого](https://ipfs.io/ipfs/QmXec1jjwzxWJoNbxQF5KffL8q6hFXm9QwUGaa3wKGk6dT/#title=Multicodecs&src=https://raw.githubusercontent.com/multiformats/multicodec/master/table.csv), чтобы программы знали, как интерпретировать контент). На официальном сайте есть [удобная страница](https://cid.ipfs.io/#bafybeigdyrzt5sfp7udm7hu76uh7y26nf3efuylqabf3oclgtqy55fbzdi), которая показывает, как интерпретировать CID.

### Что такое Merkle DAG и как это используется в IPFS?

{{< figure src="/post-resources/1-ipfs/dag.png" caption="Бинарное хеш-дерево" style="background:#F2F6FF" >}}

[Дерево Меркла](https://ru.wikipedia.org/wiki/%D0%94%D0%B5%D1%80%D0%B5%D0%B2%D0%BE_%D1%85%D0%B5%D1%88%D0%B5%D0%B9) (или Дерево Хешей) --- это полное двоичное дерево, листья которого содержат хеши блоков данных, а внутренние вершины содержат хеши от сложения значений в их дочерних вершинах. В IPFS вместо хешей используются Content Identifier.

Такая структура позволяет IPFS связывать сложные структуры, например, целую папку файлов или git-репозиторий. Большие файлы в IPFS разбиваются на чанки (размер которых зависит от типа контента), соответственно, при загрузке большого файла в IPFS также будет построено дерево хешей, имеющее свой CID и указывающего на CID каждого чанка. Существует [специальный инструмент](https://explore.ipld.io/#/explore/QmSnuWmxptJZdLJpKRarxBMS2Ju2oANVrgbr2xWbie9b2D), наглядно показывающий такие деревья.

Если вдруг мы решим изменить часть файла и опубликовать новую версию в IPFS, хеш листьев, отвечающих за изменённые блоки данных, изменится, вследствие чего изменятся хеши их родительских элементов, вплоть до корневого. Однако хеш тех листьев, контент блоков которых не изменился, останется прежним, соответственно, новый и старый файл, хоть и будут иметь разные CID, но будут ссылаться на одни и те же CID совпадающих блоков данных. Таким образом, достигается дедупликация контента.

### Обнаружение контента с помощью DHT

**Хеш-таблица** --- это обычная таблица с двумя полями: ключ и значение.
**Распределённая&nbsp;хеш-таблица** --- это таблица, которая разделена между всеми пирами в распределенной сети. Чтобы найти контент, необходимо спросить о нём среди своих пиров.

После того, как IPFS узнаёт, где находится контент (а если быть точнее, у каких пиров хранятся блоки данных, из которых состоит загружаемый контент), IPFS использует DHT ещё раз, чтобы узнать, где эти пиры находятся на данный момент (процедура маршрутизации).

Теперь мы знаем, у каких пиров есть нужный нам контент и как с этими пирами связаться. Затем, IPFS связывается с этими пирами, отправляет им список желаний (CID блоков, которые мы хотим получить), а пиры отправляют эти блоки. После получения блоков данных, IPFS генерирует CID на основе полученных данных, чтобы сверить его с CID, который мы запросили. Таким образом, можно проверить, что данные не были никем подменены.

## А где хранятся данные?

Публикуемые в IPFS данные хранятся на нодах --- участниках сети. Если вы создавали свои торрент-раздачи, вы знаете, что изначально файлы есть только у вас, вы публикуете их и раздаёте другим участникам. Если вы не успеете никому отдать свою копию файлов и выключите свой компьютер, никто не сможет скачать ваши данные, поэтому нужно дождаться, пока хотя бы несколько человек их скачают и начнут раздавать, прежде чем самому уходить с раздачи.

{{< figure src="/post-resources/1-ipfs/ipfs-desktop.png" caption="Список закреплённых файлов на локальной ноде" >}}

В IPFS всё происходит похожим образом. Как только вы публикуете какой-либо контент на локальной ноде, он "закрепляется" (**pinning**), IPFS будет хранить его вечно на вашем устройстве, пока вы не открепите его (**unpin**). Когда кто-то запросит контент, который есть у вас, он автоматически сохранит его копию в свой локальный кеш. Однако, следует иметь в виду, что данный кеш не перманентный, следовательно, со временем тот пир перестанет раздавать эту информацию, если к ней никто долго не обращался. При этом никто не запрещает другому пиру также "закрепить" скачанные от вас файлы, тогда он продолжит раздавать их вместе с вами.

>  Пользователи IPFS закрепляют себе ту информацию, которую считают ценной для себя, поэтому информация, которая никем не закреплена (а значит, никому не представляет ценности) со временем удаляется для экономии места.

Понятно, что держать опубликованную информацию на своем личном устройстве и постоянно раздавать её --- не всегда удобно, для решения этой проблемы на помощь приходят [Pinning Services](https://docs.ipfs.io/concepts/persistence/#pinning-services), по сути, это можно считать облачным хранилищем, куда можно загрузить свои данные, чтобы они были всегда доступны в IPFS.

## Интеграция с всемирной паутиной

Для интеграции с существующим вебом существует две технологии, которые применяются совместно: **IPFS Gateway** и **DNSLink**

### IPFS Gateway

[Шлюз IPFS](https://docs.ipfs.io/concepts/ipfs-gateway) --- это сервер, который позволяет получить доступ к файлам в сети IPFS из браузеров, пока не поддерживающих доступ к IPFS напрямую. Шлюз можно поднять у себя локально, либо воспользоваться публичным, например <https://ipfs.io>. Следует отметить, что при использовании шлюза, вы не сможете проверять CID скачанных файлов на клиентском устройстве, поэтому вы должны доверять шлюзу, либо не пользоваться им вовсе.

### DNSLink

[DNSLink](https://docs.ipfs.io/concepts/dnslink/) использует TXT-записи DNS для того, чтобы закрепить CID за определённым доменом. Например, мы можем узнать, что домен [ipfs.io](https://ipfs.io/) указывает на CID `Qmf6DcRku4QUBjkToCSj3dMkhipUgg1NURYSMUFNsj1jsF`:

```bash
$ dig +noall +answer TXT \_dnslink.ipfs.io
\_dnslink.ipfs.io. 30 IN TXT "dnslink=/ipns/website.ipfs.io"

$ dig +noall +answer TXT \_dnslink.website.ipfs.io
\_dnslink.website.ipfs.io. 30 IN TXT "dnslink=/ipfs/Qmf6DcRku4QUBjkToCSj3dMkhipUgg1NURYSMUFNsj1jsF"
```

Как видно из примера выше, TXT-запись `_dnslink.ipfs.io` указывала на адрес `/ipns/website.ipfs.io`, а `website.ipfs.io`, в свою очередь, указывает на конкретный IPFS CID.

Тут стоит ещё упомянуть [IPNS (InterPlanetary Name System)](https://docs.ipfs.io/concepts/ipns/). IPNS позволяет вам создавать длинные адреса вида `k5...`, которые ссылаются на конкретный CID и могут быть обновлены вами. Таким образом при загрузке новой версии файла у вас не будет необходимости рассылать всем новый CID, пользователи сразу узнают его, обращаясь к данным по IPNS. **DNSLink** является альтернативой IPNS, используя доменные имена, вместо длинных хешей. DNSLink работает быстрее и легко запоминается, однако нужно понимать, что DNS-сервера могут быть подвергнуты блокировкам, либо их ответ может быть подменён, если вы не используете [DoH или DoT](https://www.cloudflare.com/ru-ru/learning/dns/dns-over-tls/).

## Как пользоваться

Можно поставить себе консольную утилиту [ipfs-cli](https://docs.ipfs.io/how-to/command-line-quick-start/) или [десктопный клиент](https://docs.ipfs.io/install/ipfs-desktop/), который включает в себя IPFS-ноду и файловый менеджер, а также [расширение для браузера](https://docs.ipfs.io/install/ipfs-companion/#install), которое позволит открывать IPFS-ссылки в своём браузере, используя локальную ноду.

В этой статье в качестве примера мы создадим одностраничный сайт-резюме, опубликуем его в IPFS, используя один из pinning-сервисов, и настроим DNS, чтобы при открытии нашего сайта из обычного браузера пользователи могли его увидеть.

### Создание одностраничного сайта-резюме

{{< figure src="/post-resources/1-ipfs/hugo-logo-wide.svg" >}}

Нам нужно подготовить статичную версию сайта, простой набор страничек. На этом этапе долго останавливаться не будем, [на данной странице](https://gohugo.io/getting-started/quick-start/) можно найти пошаговую инструкцию по созданию такого сайта с помощью генератора [Hugo](https://gohugo.io/) ([а вот тут можно найти инструкцию на русском](https://thecode.media/hugo/)).

{{< code language="bash" title="Создаём заготовку статичного сайта" isCollapsed="false" >}}

# Устанавливаем Hugo

snap install hugo

# Создаем основу вебсайта

hugo new site my-website
cd my-website

# Устанавливаем тему

# Список существующих тем: <https://themes.gohugo.io/>

git init
git submodule add <https://github.com/gurusabarish/hugo-profile.git> themes/hugo-profile

# Включаем тему

rm config.toml
cp ./themes/hugo-profile/website/v3.yaml ./config.yaml
sed -i 's/\\.\\/\\.\\./hugo-profile/g' ./config.yaml

# Редактируем созданную конфигурацию под себя

vim ./config.yaml

# Запускаем сервер для просмотра получившегося сайта

hugo serve
{{< /code >}}

Переходим по ссылке <http://localhost:1313> и видим получившийся сайт:

{{< figure src="/post-resources/1-ipfs/hugo-bootstrap.png" caption="Одностраничный сайт на типовом шаблоне hugo-profile от Guru Sabarish" >}}

Теперь мы можем ввести команду hugo , и наш сайт скомпилируется в папку public. Содержимое этой папки мы и будем публиковать в IPFS.

### Публикация файлов в IPFS

Чтобы нам не приходилось держать свой компьютер постоянно включённым, воспользуемся одним из [Pinning сервисов](https://docs.ipfs.io/concepts/persistence/#pinning-services). Я выбрал [Pinata](https://www.pinata.cloud/), он предоставляет 1ГБ бесплатного хранилища и не требует привязки банковской карты.

После регистрации и загрузки папки public на сайт, мы получаем CID, по которому мы можем посмотреть наше содержимое:

{{< figure src="/post-resources/1-ipfs/pinata.png" caption="Жёлтым выделен Content Identifier загруженной папки" >}}

Нажав на значок глаза левее, мы можем просмотреть наш сайт в браузере (как можно заметить, я выбрал другой шаблон для своего сайта):

{{< figure src="/post-resources/1-ipfs/this-site.png" caption="Этот сайт, загруженный в IPFS и открытый через IPFS Gateway" >}}

Также мы можем открыть приложение IPFS Desktop и посмотреть содержимое папки с сайтом, введя CID в поле в верхней части интерфейса. Папка может загрузиться не сразу, следует подождать, пока IPFS найдет пиров, у которых она есть.

{{< figure src="/post-resources/1-ipfs/site-on-ipfs.png" caption="Содержимое нашей папки с сайтом, загруженной в сеть IPFS" >}}

Запомним наш CID, он пригодится нам позднее, когда мы будем настраивать свой домен: QmZkSWaUY1dTeCNokmBdV9rS2SgRBGvTzbA2Xk49EPc6FE.

### Настройка DNS, часть 1

Последним этапом будет ассоциация нашего доменного имени с Content Identifier (помните, мы говорили про [DNSLink](http://docs.ipfs.io.ipns.localhost:8080/concepts/dnslink/)?). Будем считать, что у вас уже есть собственное доменное имя и доступ к настройке его DNS-записей.

В моём распоряжении есть доменное имя [cubly.ru](https://cubly.ru), DNS-записи которого управляются через Cloudflare. Чтобы сайт был доступен по нашему доменному имени пользователям IPFS, нам необходимо создать TXT-запись с именем `_dnslink.<доменное_имя>` и значением `dnslink=/ipfs/<ваш_CID>`.

{{< figure src="/post-resources/1-ipfs/cloudflare-txt-entry.png" caption="TXT-запись, указывающая на CID моей папки" >}}

После этого наш сайт стал доступен для пользователей IPFS помимо адреса /ipfs/QmZk.. через более лаконичный и запоминающийся адрес /ipns/cubly.ru ([посмотреть через IPFS Gateway](https://ipfs.io/ipns/cubly.ru/)).

Если мы установим плагин IPFS Companion и попробуем открыть сайт [cubly.ru](https://cubly.ru) в браузере, плагин автоматически определит, что сайт доступен в IPFS (найдя созданную нами TXT-запись) и переадресует на наш локальный Gateway: <http://cubly.ru.ipns.localhost:8080>. Наш локальный IPFS Gateway убедится, что все загруженные браузером файлы подлинные, подсчитав их хеш-суммы.

{{< figure src="/post-resources/1-ipfs/ipfs-plugin-status.png" caption="TXT-запись, указывающая на CID моей папки" >}}

Как видно на скриншоте, в плагине есть опция "Import to Files on My Node". Мы можем нажать на неё, чтобы импортировать содержимое сайта на нашу IPFS-ноду и раздавать содержимое сайта уже со своего компьютера, чтобы сайт открывался быстрее у пользователей, которые находятся в вашем городе, пока IPFS Desktop запущен. Если вы закроете его, то сайт всё равно останется доступен, ведь он есть на Pinata и у других нод, которые успели закешировать его, просто вашим соседям придётся немного подождать, пока их IPFS нода найдёт другие пиры.

### Настройка DNS, часть 2

Мы настроили DNSLink запись, и сайт стал доступен по удобному имени для пользователей IPFS, но что делать с пользователями, которые ещё не пользуются Web 3.0?

Всё до банальности просто: мы настроим CNAME-запись, которая перенаправит всех обычных пользователей на публичный IPFS Gateway. Так как я пользуюсь Cloudflare, будет логично воспользоваться их собственным IPFS Gateway: cloudflare-ipfs.com. Почитать о нём можно в [блоге Cloudflare](https://blog.cloudflare.com/continuing-to-improve-our-ipfs-gateway/).

Нам же достаточно просто добавить CNAME-запись на наш домен и проверить, что сайт открывается с любого устройства:

{{< figure src="/post-resources/1-ipfs/cloudflare-cname-entry.png" caption="Добавление CNAME-записи на домен cubly.ru" >}}

Имейте в виду, что по стандарту, CNAME-запись невозможно применить на корневой домен, Cloudflare автоматически подставляет IP-адрес cloudflare-ipfs.com в нашу запись. Если ваш DNS-провайдер не умеет делать это автоматически, можно создать A-запись, указывающую на IP cloudflare-ipfs.com:

```bash
$ nslookup cloudflare-ipfs.com

Non-authoritative answer:
Name: cloudflare-ipfs.com
Address: 104.17.64.14
Name: cloudflare-ipfs.com
Address: 104.17.96.13
Name: cloudflare-ipfs.com
Address: 2606:4700::6811:400e
Name: cloudflare-ipfs.com
Address: 2606:4700::6811:600d
```

{{< figure src="/post-resources/1-ipfs/cloudflare-a-entry.png" caption="Создаём A-запись, указывающую на IP Cloudflare IPFS Gateway" >}}

Теперь сайт должен стать доступным для всех пользователей, в том числе для тех, кто не пользуется IPFS. Как видно из скриншота ниже, IPFS Companion выключен, а сайт продолжает открываться.

{{< figure src="/post-resources/1-ipfs/ipfs-plugin-off.png" caption="Размещённый в IPFS сайт доступен для всех пользователей" >}}

## Итог

В результате мы с вами познакомились с IPFS и принципом её работы, а также опубликовали свой сайт в общей сети, обеспечив доступ к нему пользователям IPFS и Web. Просматривая сайт, пользователи IPFS будут сохранять его ресурсы в своём кеше, увеличивая его доступность, скорость его загрузки и делая его более распределённым.

У IPFS масса применений, вот несколько из них:

-   хранение ресурсов, привязанных к [NFT токенам](https://ru.wikipedia.org/wiki/%D0%9D%D0%B5%D0%B2%D0%B7%D0%B0%D0%B8%D0%BC%D0%BE%D0%B7%D0%B0%D0%BC%D0%B5%D0%BD%D1%8F%D0%B5%D0%BC%D1%8B%D0%B9_%D1%82%D0%BE%D0%BA%D0%B5%D0%BD) или к транзакциям блокчейна;

-   [совместное хранение больших датасетов](https://qri.io/);

-   децентрализованный [видеохостинг](https://d.tube/) и [виртуальная реальност](https://decentraland.org/)ь;

-   CDN;

-   [Deadman Switch](https://killcord.io/);

-   [распределённая базы данных](https://github.com/orbitdb/orbit-db);

-   [и многое другое](https://awesome.ipfs.io/).

Присоединяйтесь к становлению Распределённого Веба ✌️
